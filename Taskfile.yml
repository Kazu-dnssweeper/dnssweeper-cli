# DNSweeper Task Runner Configuration
# ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« - Goãƒ™ãƒ¼ã‚¹ã®é«˜é€Ÿã‚¿ã‚¹ã‚¯å®Ÿè¡Œ

version: '3'

vars:
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ•°
  PROJECT_NAME: dnsweeper-cli
  BUILD_DIR: dist
  COVERAGE_DIR: coverage
  TEST_RESULTS_DIR: test-results
  DOCS_DIR: docs
  
  # è‰²è¨­å®š
  COLOR_SUCCESS: "\033[0;32m"
  COLOR_WARNING: "\033[0;33m"
  COLOR_ERROR: "\033[0;31m"
  COLOR_INFO: "\033[0;36m"
  COLOR_RESET: "\033[0m"

# ã‚¿ã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—
includes:
  dev: ./tasks/dev.yml
  build: ./tasks/build.yml
  test: ./tasks/test.yml
  quality: ./tasks/quality.yml
  release: ./tasks/release.yml

# ã‚¨ãƒ©ãƒ¼å‡¦ç†è¨­å®š
set:
  - e # ã‚¨ãƒ©ãƒ¼æ™‚ã«åœæ­¢
  - u # æœªå®šç¾©å¤‰æ•°ã§ã‚¨ãƒ©ãƒ¼
  - pipefail # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯
tasks:
  default:
    desc: "ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º"
    cmds:
      - task --list-all

  # é–‹ç™ºã‚¿ã‚¹ã‚¯
  dev:
    desc: "é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    deps: [setup:check]
    cmds:
      - echo "{{.COLOR_INFO}}ğŸš€ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰èµ·å‹•{{.COLOR_RESET}}"
      - pnpm run dev

  dev:watch:
    desc: "ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦è‡ªå‹•å†èµ·å‹•"
    deps: [setup:check]
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ‘€ ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰èµ·å‹•{{.COLOR_RESET}}"
      - nodemon --watch src --ext ts --exec "pnpm run dev"

  # ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¹ã‚¯
  build:
    desc: "ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰"
    deps: [clean:dist]
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ”¨ ãƒ“ãƒ«ãƒ‰é–‹å§‹{{.COLOR_RESET}}"
      - pnpm run build
      - echo "{{.COLOR_SUCCESS}}âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†{{.COLOR_RESET}}"
    sources:
      - src/**/*.ts
      - tsconfig.json
    generates:
      - dist/**/*.js

  build:fast:
    desc: "tsupã«ã‚ˆã‚‹é«˜é€Ÿãƒ“ãƒ«ãƒ‰"
    deps: [clean:dist]
    cmds:
      - echo "{{.COLOR_INFO}}âš¡ é«˜é€Ÿãƒ“ãƒ«ãƒ‰é–‹å§‹ (tsup){{.COLOR_RESET}}"
      - pnpm tsup
      - echo "{{.COLOR_SUCCESS}}âœ… é«˜é€Ÿãƒ“ãƒ«ãƒ‰å®Œäº†{{.COLOR_RESET}}"

  build:esbuild:
    desc: "esbuildã«ã‚ˆã‚‹è¶…é«˜é€Ÿãƒ“ãƒ«ãƒ‰"
    deps: [clean:dist]
    cmds:
      - echo "{{.COLOR_INFO}}âš¡âš¡ è¶…é«˜é€Ÿãƒ“ãƒ«ãƒ‰é–‹å§‹ (esbuild){{.COLOR_RESET}}"
      - pnpm esbuild
      - echo "{{.COLOR_SUCCESS}}âœ… è¶…é«˜é€Ÿãƒ“ãƒ«ãƒ‰å®Œäº†{{.COLOR_RESET}}"

  build:analyze:
    desc: "ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“Š ãƒãƒ³ãƒ‰ãƒ«åˆ†æé–‹å§‹{{.COLOR_RESET}}"
      - pnpm tsup --metafile
      - pnpm esbuild-visualizer --metadata ./dist/metafile.json --open

  # ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯
  test:
    desc: "ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    deps: [test:unit, test:e2e]
    cmds:
      - echo "{{.COLOR_SUCCESS}}âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Œäº†{{.COLOR_RESET}}"

  test:unit:
    desc: "å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ{{.COLOR_RESET}}"
      - pnpm test:unit

  test:watch:
    desc: "ãƒ†ã‚¹ãƒˆã‚’ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ‘€ ãƒ†ã‚¹ãƒˆã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰{{.COLOR_RESET}}"
      - pnpm test:watch

  test:coverage:
    desc: "ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š{{.COLOR_RESET}}"
      - pnpm test:coverage
      - echo "{{.COLOR_INFO}}ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ: {{.COVERAGE_DIR}}/index.html{{.COLOR_RESET}}"

  test:e2e:
    desc: "E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
    deps: [build]
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ­ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ{{.COLOR_RESET}}"
      - pnpm test:e2e

  # å“è³ªãƒã‚§ãƒƒã‚¯ã‚¿ã‚¹ã‚¯
  quality:
    desc: "ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ"
    cmds:
      - task: quality:parallel
      - echo "{{.COLOR_SUCCESS}}âœ… å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†{{.COLOR_RESET}}"

  quality:parallel:
    desc: "å“è³ªãƒã‚§ãƒƒã‚¯ã‚’ä¸¦åˆ—å®Ÿè¡Œ"
    deps:
      - lint
      - format:check
      - type-check

  lint:
    desc: "ESLintã§ã‚³ãƒ¼ãƒ‰æ¤œè¨¼"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ” Lintå®Ÿè¡Œ{{.COLOR_RESET}}"
      - pnpm lint
    sources:
      - src/**/*.ts
      - .eslintrc.json

  lint:fix:
    desc: "ESLintã§è‡ªå‹•ä¿®æ­£"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ”§ Lintè‡ªå‹•ä¿®æ­£{{.COLOR_RESET}}"
      - pnpm lint:fix

  format:
    desc: "Prettierã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ’… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œ{{.COLOR_RESET}}"
      - pnpm format

  format:check:
    desc: "ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯{{.COLOR_RESET}}"
      - prettier --check "src/**/*.ts"

  type-check:
    desc: "TypeScriptå‹ãƒã‚§ãƒƒã‚¯"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ” å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ{{.COLOR_RESET}}"
      - pnpm type-check
    sources:
      - src/**/*.ts
      - tsconfig.json

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¿ã‚¹ã‚¯
  clean:
    desc: "ã™ã¹ã¦ã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"
    cmds:
      - task: clean:parallel

  clean:parallel:
    desc: "ã‚¯ãƒªãƒ¼ãƒ³ã‚¿ã‚¹ã‚¯ã‚’ä¸¦åˆ—å®Ÿè¡Œ"
    deps:
      - clean:dist
      - clean:coverage
      - clean:test-results

  clean:dist:
    desc: "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"
    cmds:
      - rm -rf {{.BUILD_DIR}}

  clean:coverage:
    desc: "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
    cmds:
      - rm -rf {{.COVERAGE_DIR}}

  clean:test-results:
    desc: "ãƒ†ã‚¹ãƒˆçµæœã‚’å‰Šé™¤"
    cmds:
      - rm -rf {{.TEST_RESULTS_DIR}}

  clean:all:
    desc: "ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆnode_moduleså«ã‚€ï¼‰"
    cmds:
      - task: clean
      - rm -rf node_modules
      - rm -rf .pnpm-store
      - rm -f pnpm-lock.yaml

  # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯
  setup:
    desc: "é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ› ï¸  é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—{{.COLOR_RESET}}"
      - pnpm install
      - pnpm run setup:permissions
      - echo "{{.COLOR_SUCCESS}}âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†{{.COLOR_RESET}}"

  setup:check:
    desc: "é–‹ç™ºç’°å¢ƒã‚’ãƒã‚§ãƒƒã‚¯"
    cmds:
      - |
        if [ ! -d "node_modules" ]; then
          echo "{{.COLOR_WARNING}}âš ï¸  node_modulesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“{{.COLOR_RESET}}"
          task setup
        fi
    silent: true

  # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¹ã‚¯
  release:
    desc: "ãƒªãƒªãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè¡Œ"
    deps: [quality, test]
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹æº–å‚™{{.COLOR_RESET}}"
      - pnpm run release

  publish:
    desc: "npmã«å…¬é–‹"
    deps: [release]
    cmds:
      - echo "{{.COLOR_INFO}}ğŸš€ npmå…¬é–‹{{.COLOR_RESET}}"
      - pnpm publish

  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚¹ã‚¯
  docs:generate:
    desc: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ{{.COLOR_RESET}}"
      - typedoc --out {{.DOCS_DIR}} src

  docs:serve:
    desc: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
    deps: [docs:generate]
    cmds:
      - echo "{{.COLOR_INFO}}ğŸŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•{{.COLOR_RESET}}"
      - npx serve {{.DOCS_DIR}}

  # CI/CD ã‚¿ã‚¹ã‚¯
  ci:
    desc: "CIç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯"
    cmds:
      - task: setup
      - task: quality
      - task: test
      - task: build

  ci:fast:
    desc: "é«˜é€ŸCIã‚¿ã‚¹ã‚¯ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰"
    deps:
      - setup
    cmds:
      - task: ci:parallel

  ci:parallel:
    desc: "CIã‚¿ã‚¹ã‚¯ã‚’ä¸¦åˆ—å®Ÿè¡Œ"
    deps:
      - quality:parallel
      - test:unit
      - build:fast

  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¿ã‚¹ã‚¯
  check:deps:
    desc: "ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ” ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯{{.COLOR_RESET}}"
      - pnpm audit

  update:deps:
    desc: "ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“¦ ä¾å­˜é–¢ä¿‚æ›´æ–°{{.COLOR_RESET}}"
      - pnpm update --interactive

  info:
    desc: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º"
    cmds:
      - echo "{{.COLOR_INFO}}â„¹ï¸  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±{{.COLOR_RESET}}"
      - echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: {{.PROJECT_NAME}}"
      - echo "Node.js: $(node -v)"
      - echo "pnpm: $(pnpm -v)"
      - echo "TypeScript: $(pnpm tsc -v)"

  # ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚¿ã‚¹ã‚¯
  benchmark:
    desc: "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ"
    deps: [build]
    cmds:
      - echo "{{.COLOR_INFO}}â±ï¸  ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ{{.COLOR_RESET}}"
      - node scripts/benchmark-streaming.js

  # GitHubé€£æºã‚¿ã‚¹ã‚¯
  issue:list:
    desc: "GitHub Issueãƒªã‚¹ãƒˆã‚’è¡¨ç¤º"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“‹ Issueä¸€è¦§{{.COLOR_RESET}}"
      - gh issue list --state open

  pr:status:
    desc: "PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ”€ PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹{{.COLOR_RESET}}"
      - gh pr status

  # ã‚«ã‚¹ã‚¿ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
  workflow:morning:
    desc: "æœã®é–‹ç™ºé–‹å§‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"
    cmds:
      - echo "{{.COLOR_INFO}}â˜€ï¸  ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼é–‹ç™ºç’°å¢ƒæº–å‚™ä¸­...{{.COLOR_RESET}}"
      - task: setup:check
      - task: update:deps
      - task: issue:list
      - echo "{{.COLOR_SUCCESS}}âœ… æº–å‚™å®Œäº†ï¼ä»Šæ—¥ã‚‚è‰¯ã„é–‹ç™ºã‚’ï¼{{.COLOR_RESET}}"

  workflow:commit:
    desc: "ã‚³ãƒŸãƒƒãƒˆå‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸ“ ã‚³ãƒŸãƒƒãƒˆå‰ãƒã‚§ãƒƒã‚¯{{.COLOR_RESET}}"
      - task: quality:parallel
      - task: test:unit
      - echo "{{.COLOR_SUCCESS}}âœ… ã‚³ãƒŸãƒƒãƒˆæº–å‚™å®Œäº†{{.COLOR_RESET}}"

  workflow:release:
    desc: "ãƒªãƒªãƒ¼ã‚¹å‰ã®å®Œå…¨ãƒã‚§ãƒƒã‚¯"
    cmds:
      - echo "{{.COLOR_INFO}}ğŸš€ ãƒªãƒªãƒ¼ã‚¹å‰ãƒã‚§ãƒƒã‚¯é–‹å§‹{{.COLOR_RESET}}"
      - task: clean
      - task: setup
      - task: quality
      - task: test
      - task: build
      - task: docs:generate
      - echo "{{.COLOR_SUCCESS}}âœ… ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†ï¼{{.COLOR_RESET}}"