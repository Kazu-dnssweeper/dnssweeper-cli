name: Daily PDCA Check
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥ UTC 0:00 (JST 9:00)
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  daily-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Run tests
        id: test
        run: |
          echo "### ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          pnpm test --silent 2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "test_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "test_status=failure" >> $GITHUB_OUTPUT
          fi
          
      - name: Run build
        id: build
        run: |
          echo "### ğŸ”¨ ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          pnpm build
          if [ $? -eq 0 ]; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "build_status=failure" >> $GITHUB_OUTPUT
          fi
          
      - name: Check TypeScript
        id: typecheck
        run: |
          echo "### ğŸ“ å‹ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          pnpm typecheck
          if [ $? -eq 0 ]; then
            echo "âœ… å‹ãƒã‚§ãƒƒã‚¯æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "typecheck_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ å‹ã‚¨ãƒ©ãƒ¼ã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
            echo "typecheck_status=failure" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate daily report
        run: |
          DATE=$(date +'%Y-%m-%d')
          mkdir -p .pdca/daily
          
          cat > .pdca/daily/${DATE}-report.yml << EOF
          date: "${DATE}"
          status: "${{ steps.test.outputs.test_status == 'success' && steps.build.outputs.build_status == 'success' && steps.typecheck.outputs.typecheck_status == 'success' && 'GREEN' || 'RED' }}"
          tests: "${{ steps.test.outputs.test_status }}"
          build: "${{ steps.build.outputs.build_status }}"
          typecheck: "${{ steps.typecheck.outputs.typecheck_status }}"
          time_spent: "$(date -u -d @${SECONDS} +'%Måˆ†%Sç§’')"
          EOF
          
          echo "### ğŸ“Š æ—¥æ¬¡PDCAãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "æ—¥ä»˜: ${DATE}" >> $GITHUB_STEP_SUMMARY
          echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.test.outputs.test_status == 'success' && steps.build.outputs.build_status == 'success' && steps.typecheck.outputs.typecheck_status == 'success' && 'âœ… GREEN' || 'âŒ RED' }}" >> $GITHUB_STEP_SUMMARY
          
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Daily PDCA Check Failed - ${date}`,
              body: `## Daily PDCA Check Failed
              
              æ—¥æ¬¡PDCAãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
              
              ### è©³ç´°
              - ãƒ†ã‚¹ãƒˆ: ${{ steps.test.outputs.test_status }}
              - ãƒ“ãƒ«ãƒ‰: ${{ steps.build.outputs.build_status }}
              - å‹ãƒã‚§ãƒƒã‚¯: ${{ steps.typecheck.outputs.typecheck_status }}
              
              ### ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
              1. [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœã‚’ç¢ºèª](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              2. å•é¡Œã‚’ä¿®æ­£
              3. ä¿®æ­£å®Œäº†å¾Œã€ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
              `,
              labels: ['pdca', 'daily-check', 'automated']
            });