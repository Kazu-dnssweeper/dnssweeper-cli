name: Weekly PDCA Review
on:
  schedule:
    - cron: '0 1 * * 5'  # æ¯Žé€±é‡‘æ›œ UTC 1:00 (JST 10:00)
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  weekly-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆçµ±è¨ˆåˆ†æžç”¨ï¼‰
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Collect metrics
        id: metrics
        run: |
          echo "### ðŸ“Š é€±æ¬¡ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŽé›†" >> $GITHUB_STEP_SUMMARY
          
          # ã‚³ãƒŸãƒƒãƒˆæ•°ã‚’å–å¾—
          COMMITS_THIS_WEEK=$(git log --since="1 week ago" --oneline | wc -l)
          echo "commits_count=${COMMITS_THIS_WEEK}" >> $GITHUB_OUTPUT
          echo "- ã‚³ãƒŸãƒƒãƒˆæ•°: ${COMMITS_THIS_WEEK}" >> $GITHUB_STEP_SUMMARY
          
          # PRãƒžãƒ¼ã‚¸æ•°ã‚’å–å¾—ï¼ˆGitHubãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ï¼‰
          # PR_MERGED=$(gh pr list --state merged --limit 100 --json mergedAt --jq '[.[] | select(.mergedAt > (now - 604800))] | length')
          
          # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å–å¾—
          pnpm test:coverage --silent > coverage-output.txt 2>&1 || true
          COVERAGE=$(grep -oP 'All files.*?\|\s*\K[0-9.]+' coverage-output.txt | head -1 || echo "0")
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          echo "- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          
          # Issueçµ±è¨ˆ
          OPEN_ISSUES=$(gh issue list --state open --json number --jq 'length' || echo "0")
          echo "open_issues=${OPEN_ISSUES}" >> $GITHUB_OUTPUT
          echo "- ã‚ªãƒ¼ãƒ—ãƒ³Issueæ•°: ${OPEN_ISSUES}" >> $GITHUB_STEP_SUMMARY
          
      - name: Calculate DORA metrics
        id: dora
        run: |
          echo "### ðŸŽ¯ DORAãƒ¡ãƒˆãƒªã‚¯ã‚¹" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé »åº¦ï¼ˆé€±ã‚ãŸã‚Šã®ãƒªãƒªãƒ¼ã‚¹æ•°ï¼‰
          RELEASES_THIS_WEEK=$(gh release list --limit 10 --json createdAt --jq '[.[] | select(.createdAt > (now - 604800))] | length' || echo "0")
          echo "deployment_frequency=${RELEASES_THIS_WEEK}" >> $GITHUB_OUTPUT
          echo "- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé »åº¦: ${RELEASES_THIS_WEEK}å›ž/é€±" >> $GITHUB_STEP_SUMMARY
          
          # å¤‰æ›´å¤±æ•—çŽ‡ï¼ˆç°¡æ˜“ç‰ˆï¼šå¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‰²åˆï¼‰
          TOTAL_RUNS=$(gh run list --limit 100 --json conclusion --jq 'length' || echo "1")
          FAILED_RUNS=$(gh run list --limit 100 --json conclusion --jq '[.[] | select(.conclusion == "failure")] | length' || echo "0")
          FAILURE_RATE=$(( FAILED_RUNS * 100 / TOTAL_RUNS ))
          echo "change_failure_rate=${FAILURE_RATE}" >> $GITHUB_OUTPUT
          echo "- å¤‰æ›´å¤±æ•—çŽ‡: ${FAILURE_RATE}%" >> $GITHUB_STEP_SUMMARY
          
      - name: Generate weekly report
        run: |
          WEEK=$(date +'%Y-W%V')
          mkdir -p .pdca/weekly
          
          cat > .pdca/weekly/${WEEK}-report.yml << EOF
          week: "${WEEK}"
          status: "HEALTHY"
          metrics:
            commits: ${{ steps.metrics.outputs.commits_count }}
            test_coverage: "${{ steps.metrics.outputs.coverage }}%"
            open_issues: ${{ steps.metrics.outputs.open_issues }}
          dora:
            deployment_frequency: "${{ steps.dora.outputs.deployment_frequency }} per week"
            change_failure_rate: "${{ steps.dora.outputs.change_failure_rate }}%"
          highlights:
            - "ã‚³ãƒŸãƒƒãƒˆæ•°: ${{ steps.metrics.outputs.commits_count }}"
            - "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ${{ steps.metrics.outputs.coverage }}%"
          improvements:
            - "æ¬¡é€±ã®æ”¹å–„ææ¡ˆã‚’ã“ã“ã«è¨˜è¼‰"
          time_spent: "$(date -u -d @${SECONDS} +'%Måˆ†%Sç§’')"
          EOF
          
      - name: Create weekly review issue
        uses: actions/github-script@v7
        with:
          script: |
            const week = new Date().toISOString().slice(0, 10);
            const weekNumber = Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / 604800000);
            
            const issueBody = `## ðŸ“Š é€±æ¬¡PDCAãƒ¬ãƒ“ãƒ¥ãƒ¼ - Week ${weekNumber}
            
            ### ðŸ“ˆ ä»Šé€±ã®æˆæžœ
            - ã‚³ãƒŸãƒƒãƒˆæ•°: ${{ steps.metrics.outputs.commits_count }}
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ${{ steps.metrics.outputs.coverage }}%
            - ã‚ªãƒ¼ãƒ—ãƒ³Issue: ${{ steps.metrics.outputs.open_issues }}
            
            ### ðŸŽ¯ DORAãƒ¡ãƒˆãƒªã‚¯ã‚¹
            - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé »åº¦: ${{ steps.dora.outputs.deployment_frequency }}å›ž/é€±ï¼ˆç›®æ¨™: 3å›ž/é€±ï¼‰
            - å¤‰æ›´å¤±æ•—çŽ‡: ${{ steps.dora.outputs.change_failure_rate }}%ï¼ˆç›®æ¨™: 10%æœªæº€ï¼‰
            
            ### âœ… ä»Šé€±ã®å®Œäº†ã‚¿ã‚¹ã‚¯
            _ã“ã“ã«ä»Šé€±å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã‚’è¨˜è¼‰_
            
            ### ðŸŽ¯ æ¬¡é€±ã®å„ªå…ˆäº‹é …
            - [ ] å„ªå…ˆã‚¿ã‚¹ã‚¯1
            - [ ] å„ªå…ˆã‚¿ã‚¹ã‚¯2
            - [ ] å„ªå…ˆã‚¿ã‚¹ã‚¯3
            
            ### ðŸ’¡ æ”¹å–„ææ¡ˆ
            _ç¶™ç¶šçš„æ”¹å–„ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã“ã“ã«è¨˜è¼‰_
            
            ---
            
            **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ã“ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã§æŒ¯ã‚Šè¿”ã‚Šã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Weekly PDCA Review - Week ${weekNumber}`,
              body: issueBody,
              labels: ['pdca', 'weekly-review', 'automated'],
              assignees: []
            });
            
      - name: Commit PDCA reports
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .pdca/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ“Š Add PDCA reports [skip ci]" && git push)