name: Claude Code Action

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆæ—¥æœ¬æ™‚é–“ 23:00, 0:00, 1:00, 2:00, 3:00, 4:00, 5:00ï¼‰
  schedule:
    - cron: '0 14,15,16,17,18,19,20 * * *'
  
  # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãƒˆãƒªã‚¬ãƒ¼
  issue_comment:
    types: [created]
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for Claude to perform'
        required: true
        default: 'analyze-and-improve'
        type: choice
        options:
          - analyze-and-improve
          - enhance-tests
          - optimize-performance
          - update-documentation
          - security-review

jobs:
  claude-development:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests before Claude action
      run: npm test -- --passWithNoTests --ci --forceExit
      continue-on-error: true
    
    - name: Prepare task for Claude
      id: prepare-task
      run: |
        if [ "${{ github.event_name }}" == "schedule" ]; then
          # å¤œé–“è‡ªå‹•å®Ÿè¡Œæ™‚ã®ã‚¿ã‚¹ã‚¯
          echo "task=ä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§æ”¹å–„ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
          1. å¤±æ•—ã—ã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã®ä¿®æ­£
          2. æ–°æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆpatterns.jsonã®æ‹¡å……ãªã©ï¼‰
          3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–
          4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°
          5. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Šï¼ˆç›®æ¨™80%ï¼‰" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" == "issue_comment" ]; then
          # ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º
          echo "task=${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
        else
          # æ‰‹å‹•å®Ÿè¡Œæ™‚
          echo "task=${{ github.event.inputs.task }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Claude Code Action
      uses: anthropics/claude-code-action@beta
      with:
        api-key: ${{ secrets.CLAUDE_API_KEY }}
        model: claude-3-sonnet-20240229
        max-tokens: 4000
        temperature: 0.3
        task: |
          DNSweeper CLIã®é–‹ç™ºã‚¿ã‚¹ã‚¯:
          
          ${{ steps.prepare-task.outputs.task }}
          
          ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:
          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: DNSweeper CLI (DNSæœªä½¿ç”¨ãƒ¬ã‚³ãƒ¼ãƒ‰æ¤œå‡ºãƒ„ãƒ¼ãƒ«)
          - è¨€èª: TypeScript
          - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: Commander.js, Jest
          - é–‹ç™ºãƒ«ãƒ¼ãƒ«: CLAUDE.md, DNSweeper Claude Code é–‹ç™ºãƒ«ãƒ¼ãƒ«.md ã‚’å‚ç…§
          
          å®Ÿè¡Œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³:
          1. å¿…ãšæ—¥æœ¬èªã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã
          2. ãƒ†ã‚¹ãƒˆã¯å¿…ãšå®Œèµ°ã•ã›ã‚‹
          3. ã‚¨ãƒ©ãƒ¼ã‚¼ãƒ­åŸå‰‡ã‚’å®ˆã‚‹
          4. å¤‰æ›´å¾Œã¯dnssweeper-context.mdã‚’æ›´æ–°ã™ã‚‹
    
    - name: Run tests after Claude action
      run: npm test -- --passWithNoTests --ci --forceExit
    
    - name: Create pull request
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "feat: Claude Code automatic improvements"
        title: "ğŸ¤– Claude Code Automatic Improvements"
        body: |
          ## ğŸ¤– è‡ªå‹•æ”¹å–„PR
          
          ã“ã®PRã¯Claude Code Actionã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          
          ### å®Ÿè¡Œã‚¿ã‚¹ã‚¯
          ${{ steps.prepare-task.outputs.task }}
          
          ### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          - [ ] ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹
          - [ ] TypeScriptã‚¨ãƒ©ãƒ¼ãŒãªã„
          - [ ] ESLintã‚¨ãƒ©ãƒ¼ãŒãªã„
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
          
          ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼
          @Kazu-dnssweeper
        branch: claude-improvements-${{ github.run_number }}
        delete-branch: true
    
    - name: Notify Slack (optional)
      if: always() && env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        STATUS="${{ job.status }}"
        COLOR=$([ "$STATUS" == "success" ] && echo "good" || echo "danger")
        MESSAGE="Claude Code Action: $STATUS\\nã‚¿ã‚¹ã‚¯: ${{ steps.prepare-task.outputs.task }}"
        
        curl -X POST $SLACK_WEBHOOK_URL \
          -H 'Content-Type: application/json' \
          -d "{\"attachments\": [{\"color\": \"$COLOR\", \"text\": \"$MESSAGE\"}]}"