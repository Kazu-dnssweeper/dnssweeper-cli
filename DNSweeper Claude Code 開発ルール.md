# DNSweeper CLI版 開発ルール（Claude Code用）

## 🚨 絶対に守るルール

### 0. 品質基準の絶対ルール ⚠️ 【最重要】

#### エラーゼロ原則
- **すべてのエラー・警告を完全解消してから次の作業に進む**
- TypeScriptの型エラー：1つでも残してはならない
- ESLintの警告：1つでも残してはならない
- Jestテストの失敗：1つでも許されない
- **「とりあえず動く」は品質基準違反**

#### テスト実行基準
- **テストは必ず最後まで完走させる**
- タイムアウトでの中断は品質基準違反
- すべてのテストがPASSすることを確認
- カバレッジ基準を満たすことを確認
- プロセスが正常終了することを確認

#### npm公開前チェックリスト
- [ ] `npm run type-check` → エラーゼロ
- [ ] `npm run lint` → 警告ゼロ  
- [ ] `npm test` → 10秒以内に完走、全PASS
- [ ] `npm run build` → エラーゼロ
- [ ] `npm pack --dry-run` → 成功
- [ ] README.mdの最新性確認
- [ ] LICENSEファイル存在確認
- [ ] セキュリティ監査通過確認

#### 問題解決の手順
1. **問題を特定する**（detectOpenHandles等を活用）
2. **根本原因を解決する**（応急処置ではなく）
3. **3回連続で正常動作を確認する**
4. **品質チェックリストをすべて満たす**
5. **次の作業に進む**

#### DNS品質の特別基準
- DNSはインフラの要：99.9%の品質では不十分
- 読み取り専用の厳守：データ破損リスクゼロ
- エラーハンドリングの完璧性：異常終了は許されない
- パフォーマンス基準：大規模ファイルでも安定動作

### 1. 言語ルール
- **すべてのコメントは日本語で書く**
- CLIの出力メッセージは日本語（-e オプションで英語）
- エラーメッセージも日本語
- 変数名・関数名は英語でOK（業界標準）

### 2. セキュリティルール
- **読み取り専用を徹底**
  - DNSレコードの削除機能は実装しない
  - APIキーは環境変数から読み込む
  - ローカル実行のみ（サーバー不要）

### 3. 開発ルール
- **TypeScriptを使用**
  - 型安全性を重視
  - anyの使用は最小限
  - strictモードで開発

### 4. CLIデザインルール
- **シンプルなコマンド**
  - `dnssweeper analyze <file>` が基本
  - オプションは最小限
  - 色分け出力（chalk使用）

### 5. テストルール
- **作成済みテストデータを活用**
  - test-data/フォルダのCSVでテスト
  - エッジケースも必ずテスト
  - 日本語ドメインも考慮

### 6. Claudeへの絶対ルール（2025/07/09更新）
- **毎回必ず以下を完璧に確認してから回答すること**
  - 指示内容をすべて読み込んで確認
  - ペーストされた内容をくまなく確認
  - チャットの履歴をすべて確認
  - 見落としや読み飛ばしは厳禁
  - **実行計画セクションは絶対に削除しない**

### 🚨 作業終了時の絶対ルール（2025/07/09更新）
- **「終わる」「終了」「お疲れ」等の言葉を検出したら以下のフォーマットで応答**

```markdown
## 作業完了

### 📝 md更新状況
□ dnssweeper-context.md - [更新済み/未更新]
□ 開発ルール.md - [更新済み/未更新/更新不要]

### 今回の成果
- 完了した作業のまとめ
```

- **このフォーマットを出力することで更新忘れを防ぐ**
- **「未更新」と書く前に必ず更新を実行する**

## 📝 DNSweeper作業完了時の更新チェックリスト

□ dnssweeper-context.md を更新（必須）
  - 今日の進捗を追記
  - TODOの更新
  - 達成率の更新

□ 開発ルール.md の実行計画を更新（該当する場合）
  - ✅マークを付ける
  - 日付を記録
  - 計画変更があれば履歴に記載

□ 両方更新が必要か確認
  - Phase完了時は両方
  - 日次作業は context.md のみでOK
  - Milestoneに関わる進捗があれば両方

## 📝 指示更新ルール

### 指示の書き方フォーマット
更新履歴のような形式で指示を記載する：
- 日付を明記（例：2025/07/08）
- ✅ 完了した項目
- 🔄 進行中の項目
- □ 未着手の項目
- 箇条書きで整理
- 変更点を明確に記載

### 記号の使い方
- ✅：完了したタスク
- 🔄：進行中のタスク
- □：未着手のタスク
- ❌：中止・削除されたタスク
- ⚠️：注意が必要な項目
- 📝：メモ・備考

## 📁 プロジェクト構造

```
dnssweeper-cli/
├── src/
│   ├── commands/      # CLIコマンド
│   ├── analyzers/     # 分析ロジック
│   ├── parsers/       # CSVパーサー
│   ├── patterns/      # 判定パターン
│   └── utils/         # ユーティリティ
├── test/              # テストファイル
├── test-data/         # テストCSV（作成済み）
├── patterns.json      # 判定パターン（作成済み）
├── messages-*.json    # メッセージファイル（作成済み）
└── dnssweeper-context.md  # Claude Code用コンテキスト
```

## 🛠 開発フロー

1. **機能追加前に確認**
   - patterns.jsonに既存パターンがないか
   - messages-*.jsonにメッセージがあるか
   - test-data/でテスト可能か

2. **コミットメッセージ**
   ```
   feat: 機能追加
   fix: バグ修正
   docs: ドキュメント更新
   test: テスト追加
   refactor: リファクタリング
   ```

3. **エラー処理**
   - try-catchで囲む
   - ユーザーフレンドリーなエラーメッセージ
   - 終了コードを適切に設定

## ⚡ よく使うコマンド

```bash
# 開発実行
npm run dev -- analyze test-data/normal-records-50.csv

# ビルド
npm run build

# テスト実行
npm test

# 型チェック
npm run type-check

# フォーマット
npm run format
```

## 🎯 DNSweeper特有のルール

1. **CSVパース**
   - Cloudflare形式を前提
   - エンコーディングはUTF-8
   - 空行は無視

2. **レコード判定ロジック**
   - patterns.jsonのルールに従う
   - リスクスコア0-100で評価
   - 5段階で色分け表示

3. **出力フォーマット**
   - ターミナルでの見やすさ重視
   - 統計情報を先に表示
   - 詳細は後ろに

## 📝 Claude Code活用Tips

1. **コンテキスト管理**
   ```bash
   # 作業開始時
   claude "dnssweeper-context.mdを読んで続きから"
   
   # 作業終了時（自動実行される）
   claude "今日の進捗をdnssweeper-context.mdに追記"
   ```

2. **効率的な指示**
   - 日本語で具体的に
   - 作成済みファイルの活用を明記
   - エラー時は詳細を伝える

3. **自動化環境**
   - `.claude-session-rules`ファイルでルール自動化
   - 終了キーワード検出で強制md更新
   - 開始キーワード検出で自動context読み込み

## 🚫 やってはいけないこと

- DNSレコードの自動削除
- APIキーのハードコード
- 無限ループの可能性があるコード
- グローバル変数の多用
- console.logの残し忘れ

## 💡 推奨事項

- 進捗バーの表示（ora使用）
- 実行時間の計測と表示
- ドライラン機能の実装
- デバッグモードの用意

## 🗓 実行計画（2025/07/09策定）【⚠️ この項目は絶対に削除禁止・変更は可】

### 📌 重要：この実行計画について
- **この項目は絶対に削除しないこと**
- 変更・更新は可能（日付と変更内容を記録）
- 進捗に応じて✅マークを付けていく

### Phase 1: 基礎構築（1ヶ月目）✅ 完了（2025/07/10）
#### Milestone 1.1: 開発環境構築
- ✅ TypeScript + Node.js環境構築（2025/07/09）
- ✅ ESLint + Prettier設定完了（2025/07/09）
- ✅ Git初期化（ローカル）（2025/07/09）
- ✅ フォルダ構造作成（2025/07/09）

#### Milestone 1.2: コア機能実装
- ✅ CSVパーサー実装（papaparse使用）（2025/07/09）
- ✅ patterns.json読み込み機能（2025/07/09）
- ✅ 基本的なパターンマッチング（2025/07/09）
- ✅ リスクスコア計算ロジック（2025/07/09）
- ✅ シンプルなコンソール出力（2025/07/09）

#### Milestone 1.3: テスト基盤構築
- ✅ Jest環境設定（2025/07/09）
- ✅ 単体テスト作成（カバレッジ28.65%→65%+達成）（2025/07/09）
  - ✅ formatter.tsカバレッジ：10.11%→92.13%
  - ✅ analyze.test.ts：全12テスト成功
  - ✅ Jest ES Moduleエラー解決（Chalk/Ora）
  - ✅ parsersモジュール：97.22%カバレッジ
  - ✅ patternsモジュール：96.96%カバレッジ
  - ✅ patternLoader.test.ts新規作成
- [ ] 基本的なE2Eテスト
- ✅ CI設定ファイル作成（まだ動かさない）（2025/07/09）

#### Milestone 1.4: CLI体験向上
- ✅ commander導入（コマンド体系）（2025/07/10）
- ✅ chalk導入（色付き出力）（2025/07/10）
- ✅ エラーハンドリング実装（2025/07/10）
- ✅ ヘルプメッセージ実装（2025/07/10）

### Phase 2: 公開準備（2ヶ月目）
#### Milestone 2.1: ドキュメント作成
- [ ] README.md（日本語）完成
- [ ] インストール手順
- [ ] 使用例（スクリーンショット付き）
- [ ] FAQ作成

#### Milestone 2.2: 品質向上
- [ ] リファクタリング完了
- [ ] TypeScript strictモード対応
- [ ] パフォーマンス最適化
- [ ] メモリ使用量チェック

#### Milestone 2.3: GitHub公開
- [ ] ライセンス追加（MIT）
- [ ] .gitignore最適化
- [ ] セキュリティチェック完了
- [ ] publicリポジトリとして公開
- [ ] GitHub Actions有効化

#### Milestone 2.4: npm公開準備
- [ ] package.json最適化
- [ ] npm scripts整理
- [ ] グローバルインストール対応
- [ ] `npm pack`でのテスト完了

### Phase 3: 初期展開（3ヶ月目）
#### Milestone 3.1: npm公開
- [ ] npm publish実行
- [ ] インストールテスト（複数環境）
- [ ] 初期バグ修正
- [ ] v1.0.1リリース（必要に応じて）

#### Milestone 3.2: 日本語圏展開
- [ ] Qiita記事公開
- [ ] 実践的な使用例記載
- [ ] X（Twitter）での告知
- [ ] 初期フィードバック収集

#### Milestone 3.3: 機能拡張①
- [ ] 進捗表示実装（ora使用）
- [ ] 複数ファイル対応
- [ ] 統計情報の詳細化
- [ ] v1.1.0リリース

#### Milestone 3.4: 出力形式拡張
- [ ] JSON出力対応
- [ ] CSV出力対応
- [ ] サマリーレポート機能
- [ ] v1.2.0リリース

### Phase 4: 成長期（4-6ヶ月目）
#### Milestone 4.1: 英語対応（4ヶ月目）
- [ ] 英語メッセージ実装
- [ ] README.md英語版
- [ ] dev.to記事公開
- [ ] グローバルユーザー獲得

#### Milestone 4.2: エンタープライズ機能（5ヶ月目）
- [ ] 大規模ファイル対応（ストリーミング）
- [ ] カスタムパターン機能
- [ ] 設定ファイル対応
- [ ] HTMLレポート生成

#### Milestone 4.3: エコシステム構築（6ヶ月目）
- [ ] プラグインシステム設計
- [ ] API仕様公開
- [ ] コントリビューターガイド作成
- [ ] 他DNSプロバイダー対応開始

### 📊 進捗記録
**記録方法**: 完了したら日付を追記
```
例：
- ✅ TypeScript環境構築（2025/07/10）
- ✅ ESLint + Prettier設定完了（2025/07/10）
```

### 🔄 計画変更履歴
**記録方法**: 変更内容と理由を記載
```
例：
#### 2025/07/XX
- 変更内容：〇〇を△△に変更
- 理由：××のため
```

#### 2025/07/10
- 変更内容：Phase 1完了を記録
- 理由：Milestone 1.1-1.4すべて完了済みのため
- 次のフェーズ：Phase 2（公開準備）に移行

---
⚠️ **再度警告：この実行計画セクションは削除厳禁です**

---
最終更新：2025年7月9日